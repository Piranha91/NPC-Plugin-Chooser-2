<reactiveui:ReactiveUserControl x:Class="NPC_Plugin_Chooser_2.Views.ModsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:NPC_Plugin_Chooser_2.Views"
             xmlns:vm="clr-namespace:NPC_Plugin_Chooser_2.View_Models"
             xmlns:reactiveui="http://reactiveui.net"
             xmlns:System="clr-namespace:System;assembly=mscorlib"
             mc:Ignorable="d"
             x:TypeArguments="vm:VM_Mods"
             d:DataContext="{d:DesignInstance Type=vm:VM_Mods}"
             d:DesignHeight="600" d:DesignWidth="1000"
             Loaded="ModsView_Loaded">

    <UserControl.Resources>
        <local:BooleanNegationConverter x:Key="BooleanNegationConverter"/>
        <local:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <local:IsNotNullConverter x:Key="IsNotNullConverter"/>
        <local:ModStatusToolTipMultiConverter x:Key="ModStatusToolTipMultiConverter"/>
        <local:PathExistenceToBrushConverter x:Key="PathExistenceToBrushConverter"/>
        <local:ModSettingLinkButtonTooltipConverter x:Key="ModSettingLinkButtonTooltipConverter"/>
        <local:ModKeyToStringConverter x:Key="ModKeyToStringConverter"/>
        <local:AreModKeysEqualMultiConverter x:Key="AreModKeysEqualMultiConverter"/>
        <local:PercentageSizingConverter x:Key="PercentageSizingConverter"/>
        <local:PatchingModeToVisibilityConverter x:Key="PatchingModeConverter" />

        <Style x:Key="LinkButtonStyle" TargetType="Button">
             <Setter Property="Cursor" Value="Hand"/>
             <Setter Property="ToolTip" Value="Show NPCs for this mod"/>
             <Setter Property="BorderThickness" Value="0"/> 
             <Setter Property="Padding" Value="0"/> 
             <Setter Property="Foreground" Value="DodgerBlue"/>
             <Setter Property="Background" Value="Transparent"/>
             <Setter Property="HorizontalAlignment" Value="Left"/>
             <Setter Property="VerticalAlignment" Value="Center"/>
             <Setter Property="Template">
                 <Setter.Value>
                     <ControlTemplate TargetType="Button">
                         <Border Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                              <TextBlock x:Name="PART_Text"
                                        TextDecorations="Underline"
                                        Foreground="{TemplateBinding Foreground}"
                                        HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                        VerticalAlignment="{TemplateBinding VerticalContentAlignment}">
                                     <ContentPresenter ContentSource="Content"/>
                              </TextBlock>
                         </Border>
                         <ControlTemplate.Triggers>
                             <Trigger Property="IsMouseOver" Value="True">
                                 <Setter Property="Foreground" Value="Blue"/>
                             </Trigger>
                             <Trigger Property="IsPressed" Value="True">
                                 <Setter Property="Foreground" Value="DarkBlue"/>
                             </Trigger>
                         </ControlTemplate.Triggers>
                     </ControlTemplate>
                 </Setter.Value>
             </Setter>
        </Style>
    </UserControl.Resources>

    <Grid Margin="5">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/> <!-- Main Content -->
            <RowDefinition Height="Auto"/> <!-- Zoom Control Row -->
        </Grid.RowDefinitions>
        
        <Grid Grid.Row="0" x:Name="MainContentGridForSplitter">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" x:Name="LeftColumnForModList"/> 
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*" MinWidth="300" x:Name="RightPanelColumn"/> 
            </Grid.ColumnDefinitions>

            <!-- Left Panel Content -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/> 
                    <RowDefinition Height="*"/>    
                </Grid.RowDefinitions>

                <Border Grid.Row="0" BorderBrush="LightGray" BorderThickness="0,0,0,1" Margin="0,0,0,5" Padding="5">
                    <WrapPanel Orientation="Horizontal">
                        <StackPanel Orientation="Horizontal" Margin="0,2,15,2">
                             <TextBlock Text="Filter Name:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                             <TextBox Text="{Binding NameFilterText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" MinWidth="120" VerticalAlignment="Center"/>
                        </StackPanel>
                         <StackPanel Orientation="Horizontal" Margin="0,2,15,2">
                            <TextBlock Text="Filter Plugin:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                            <TextBox Text="{Binding PluginFilterText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" MinWidth="120" VerticalAlignment="Center"/>
                        </StackPanel>
                         <StackPanel Orientation="Horizontal" Margin="0,2,15,2">
                            <TextBlock Text="Filter NPC:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                            <ComboBox ItemsSource="{Binding AvailableNpcSearchTypes}"
                                      SelectedItem="{Binding SelectedNpcSearchType, Mode=TwoWay}"
                                      MinWidth="80" VerticalAlignment="Center" Margin="0,0,5,0"
                                      IsEnabled="{Binding IsLoadingNpcData, Converter={StaticResource BooleanNegationConverter}}"
                                      ToolTip="Select NPC field to filter by (active after initial load)"/>
                            <TextBox Text="{Binding NpcSearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     MinWidth="120" VerticalAlignment="Center"
                                     IsEnabled="{Binding IsLoadingNpcData, Converter={StaticResource BooleanNegationConverter}}"
                                     ToolTip="Enter NPC search term (active after initial load)"/>
                        </StackPanel>
                        <TextBlock Text="Loading NPC data..." Foreground="Gray" FontStyle="Italic"
                                   Margin="15,0,0,0" VerticalAlignment="Center"
                                   Visibility="{Binding IsLoadingNpcData, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </WrapPanel>
                </Border>
                
                <!-- ============================ VIRTUALIZATION FIX START ============================ -->
                <!-- Replaced ScrollViewer + ItemsControl with a single ListBox.
                     The ListBox has a correctly configured built-in ScrollViewer that enables virtualization.
                     The ItemContainerStyle removes the default selection highlight, making it look like an ItemsControl. -->
                <ListBox Grid.Row="1" ItemsSource="{Binding ModSettingsList}" x:Name="ModSettingsItemsControl"
                         BorderThickness="0"
                         Background="Transparent"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         ScrollViewer.VerticalScrollBarVisibility="Auto">

                    <!-- This style makes the ListBoxItems behave like the old ItemsControl items
                         (no selection highlight, no border, etc.) -->
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0"/>
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="Focusable" Value="False"/> <!-- Prevents dotted focus rectangle -->
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border Background="{TemplateBinding Background}"
                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                BorderThickness="{TemplateBinding BorderThickness}"
                                                Padding="{TemplateBinding Padding}"
                                                SnapsToDevicePixels="true">
                                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" 
                                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}" 
                                                              SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>

                    <!-- The ItemsPanel is the same, but it will now virtualize correctly inside the ListBox -->
                    <ListBox.ItemsPanel>
                        <ItemsPanelTemplate>
                            <VirtualizingStackPanel Orientation="Vertical"/>
                        </ItemsPanelTemplate>
                    </ListBox.ItemsPanel>

                    <!-- The ItemTemplate is the same, but RelativeSource bindings are updated -->
                    <ListBox.ItemTemplate>
                         <DataTemplate DataType="{x:Type vm:VM_ModSetting}">
                             <Border BorderThickness="1" Margin="0,5" Padding="10" CornerRadius="3">
                                 <Border.Style>
                                     <Style TargetType="Border">
                                         <Setter Property="BorderBrush" Value="DarkGray"/>
                                         <Setter Property="ToolTip" Value="Status: Incomplete (Requires Mugshot Path and/or Mod Data Path assignment)."/>
                                         <Setter Property="Background" Value="White"/>
                                         <Style.Triggers>
                                             <MultiDataTrigger>
                                                 <MultiDataTrigger.Conditions>
                                                     <Condition Binding="{Binding HasMugshotPathAssigned}" Value="True"/>
                                                     <Condition Binding="{Binding HasModPathsAssigned}" Value="True"/>
                                                 </MultiDataTrigger.Conditions>
                                                 <Setter Property="BorderBrush" Value="Green"/>
                                                 <Setter Property="ToolTip" Value="Status: OK (Has Mugshot path and Mod Data path(s))."/>
                                             </MultiDataTrigger>
                                             <MultiDataTrigger>
                                                 <MultiDataTrigger.Conditions>
                                                     <Condition Binding="{Binding HasMugshotPathAssigned}" Value="False"/>
                                                     <Condition Binding="{Binding HasModPathsAssigned}" Value="True"/>
                                                 </MultiDataTrigger.Conditions>
                                                 <Setter Property="BorderBrush" Value="Purple"/> 
                                                 <Setter Property="ToolTip" Value="Status: Partial (Has Mod Data path(s), but no Mugshot path assigned)."/>
                                             </MultiDataTrigger>
                                             <MultiDataTrigger>
                                                 <MultiDataTrigger.Conditions>
                                                     <Condition Binding="{Binding HasMugshotPathAssigned}" Value="True"/>
                                                     <Condition Binding="{Binding HasModPathsAssigned}" Value="False"/>
                                                 </MultiDataTrigger.Conditions>
                                                 <Setter Property="BorderBrush" Value="Orange"/>
                                                 <Setter Property="ToolTip" Value="Status: Partial (Has Mugshot path, but no Mod Data path(s) assigned)."/>
                                             </MultiDataTrigger>
                                              <DataTrigger Binding="{Binding IsMugshotOnlyEntry}" Value="True">
                                                  <Setter Property="Background" Value="#FFF8F8F8"/>
                                                   <Setter Property="ToolTip">
                                                        <Setter.Value>
                                                             <MultiBinding Converter="{StaticResource ModStatusToolTipMultiConverter}"> 
                                                                 <Binding Path="HasMugshotPathAssigned"/>
                                                                 <Binding Path="HasModPathsAssigned"/>
                                                                 <Binding Path="IsMugshotOnlyEntry"/>
                                                             </MultiBinding>
                                                        </Setter.Value>
                                                   </Setter>
                                              </DataTrigger>
                                         </Style.Triggers>
                                     </Style>
                                 </Border.Style>
                                 <Grid>
                                     <Grid.RowDefinitions>
                                         <RowDefinition Height="Auto"/> 
                                         <RowDefinition Height="Auto"/> 
                                         <RowDefinition Height="Auto"/> 
                                         <RowDefinition Height="Auto"/> 
                                         <RowDefinition Height="Auto"/> 
                                         <RowDefinition Height="Auto"/> 
                                         <RowDefinition Height="Auto"/> 
                                     </Grid.RowDefinitions>
                                     <Grid.ColumnDefinitions>
                                         <ColumnDefinition Width="*"/>
                                     </Grid.ColumnDefinitions>

                                     <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,0,5">
                                         <StackPanel Orientation="Horizontal">
                                             <Viewbox Stretch="Uniform" 
                                                      HorizontalAlignment="Center" 
                                                      VerticalAlignment="Center"
                                                      MaxHeight="25"
                                                      Visibility="{Binding HasPluginWithOverrideRecords, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                 <Viewbox.ToolTip>
                                                     <ToolTip>
                                                         <TextBlock TextWrapping="Wrap">
                                                             This mod has overrides of non-NPC records.
                                                             <LineBreak/>
                                                             NPC2 can handle these using the default option in the settings menu, or on a per-mod basis configured here.
                                                             <LineBreak/>
                                                             <LineBreak/>
                                                             IMPORTANT: Just because the plugin has overrides doesn't mean these overrides need to be handled. In most cases, non-NPC overrides are safe to ignore,
                                                             <LineBreak/>
                                                             and handling them for large plugins can slow down patching considerably. Only handle them if the NPC appearance is bugged otherwise, or you know that it's required.
                                                         </TextBlock>
                                                     </ToolTip>
                                                 </Viewbox.ToolTip>
                                                 <Image Source="/NPC Plugin Chooser 2;component/Resources/Contains Overrides.png" />
                                             </Viewbox>
                                             <!-- *** FIX: AncestorType is now ListBox *** -->
                                              <Button Style="{StaticResource LinkButtonStyle}"
                                                      Command="{Binding DataContext.ShowMugshotsCommand, RelativeSource={RelativeSource AncestorType={x:Type ListBox}}}"
                                                      CommandParameter="{Binding}"
                                                      ToolTipService.ShowOnDisabled="False">
                                             <Button.ToolTip>
                                                 <MultiBinding Converter="{StaticResource ModSettingLinkButtonTooltipConverter}">
                                                     <Binding Path="HasValidMugshots"/>
                                                     <Binding Path="NpcFormKeys.Count"/>
                                                 </MultiBinding>
                                             </Button.ToolTip>
                                             <TextBlock Text="{Binding DisplayName}" FontWeight="Bold" FontSize="14"/>
                                             </Button>
                                             <TextBlock Text="{Binding ModKeyDisplaySuffix}"
                                                        FontWeight="Normal" 
                                                        FontSize="12" Margin="5,0,0,0" VerticalAlignment="Center" Foreground="DarkSlateGray">
                                                 <TextBlock.Style>
                                                     <Style TargetType="TextBlock">
                                                         <Setter Property="Visibility" Value="Visible"/>
                                                         <Setter Property="ToolTip">
                                                             <Setter.Value>
                                                                 <ToolTip>
                                                                     <ItemsControl ItemsSource="{Binding CorrespondingModKeys}">
                                                                         <ItemsControl.ItemTemplate>
                                                                             <DataTemplate>
                                                                                 <TextBlock Text="{Binding FileName.String}"/>
                                                                             </DataTemplate>
                                                                         </ItemsControl.ItemTemplate>
                                                                     </ItemsControl>
                                                                 </ToolTip>
                                                             </Setter.Value>
                                                         </Setter>
                                                         <Style.Triggers>
                                                             <DataTrigger Binding="{Binding ModKeyDisplaySuffix}" Value="{x:Static System:String.Empty}">
                                                                 <Setter Property="Visibility" Value="Collapsed"/>
                                                                 <Setter Property="ToolTip" Value="{x:Null}"/>
                                                             </DataTrigger>
                                                             <DataTrigger Binding="{Binding ModKeyDisplaySuffix}" Value="{x:Null}">
                                                                 <Setter Property="Visibility" Value="Collapsed"/>
                                                                 <Setter Property="ToolTip" Value="{x:Null}"/>
                                                             </DataTrigger>
                                                         </Style.Triggers>
                                                     </Style>
                                                 </TextBlock.Style>
                                             </TextBlock>
                                         </StackPanel>
                                         <Grid Margin="10,5,0,0">
                                             <Grid.ColumnDefinitions>
                                                 <ColumnDefinition Width="Auto"/>
                                                 <ColumnDefinition Width="*"/>
                                                 <ColumnDefinition Width="Auto"/>
                                             </Grid.ColumnDefinitions>
                                             <TextBlock Grid.Column="0" Text="Mugshot Folder:" VerticalAlignment="Center" ToolTip="Folder where mugshots for this mod are located"/>
                                             <TextBlock Grid.Column="1" Text="{Binding MugShotFolderPath, TargetNullValue='(Not Set)'}" VerticalAlignment="Center" Margin="5,0" ToolTip="{Binding MugShotFolderPath}" TextTrimming="CharacterEllipsis"/>
                                             <Button Grid.Column="2" Content="Browse..." Command="{Binding BrowseMugshotFolderCommand}" Padding="5,1" VerticalAlignment="Center" ToolTip="Select the folder containing Mugshots for this mod"/>
                                         </Grid>
                                     </StackPanel>

                                     <Grid Grid.Row="1" Grid.Column="0" Margin="0,5,0,5">
                                          <Grid.ColumnDefinitions>
                                              <ColumnDefinition Width="Auto"/>
                                              <ColumnDefinition Width="*"/>
                                              <ColumnDefinition Width="Auto"/>
                                          </Grid.ColumnDefinitions>
                                          <TextBlock Grid.Column="0" Text="Corresponding Mod Folder Paths:" FontWeight="SemiBold" VerticalAlignment="Center" ToolTip="Folder(s) containing plugins and resources (e.g. Meshes, Textures, FaceGen) for this mod."/>
                                          <Button Grid.Column="2" Content="Add" Command="{Binding AddFolderPathCommand}" Padding="5,1" VerticalAlignment="Center" 
                                                  Visibility="{Binding IsAutoGenerated, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}"
                                                  ToolTip="Add another data folder where the contents of this mod are located"/>
                                     </Grid>

                                      <ItemsControl Grid.Row="2" Grid.Column="0" ItemsSource="{Binding CorrespondingFolderPaths}" Margin="10,0,0,0">
                                         <ItemsControl.ItemTemplate>
                                             <DataTemplate>
                                                 <Grid Margin="0,2">
                                                     <Grid.ColumnDefinitions>
                                                         <ColumnDefinition Width="*"/>
                                                         <ColumnDefinition Width="Auto"/>
                                                         <ColumnDefinition Width="Auto"/>
                                                     </Grid.ColumnDefinitions>
                                                     <TextBlock Grid.Column="0" Text="{Binding}" VerticalAlignment="Center" ToolTip="{Binding}" TextTrimming="CharacterEllipsis">
                                                         <TextBlock.Foreground>
                                                             <Binding Path="." Converter="{StaticResource PathExistenceToBrushConverter}"/>
                                                         </TextBlock.Foreground>
                                                     </TextBlock>
                                                     <Button Grid.Column="1" Content="Browse..." 
                                                             Command="{Binding DataContext.BrowseFolderPathCommand, RelativeSource={RelativeSource AncestorType={x:Type ListBoxItem}}}" 
                                                             CommandParameter="{Binding}" Padding="5,1" Margin="5,0" VerticalAlignment="Center" ToolTip="Select a data folder for the contents of this mod"/>

                                                     <Button Grid.Column="2" Content="X" Foreground="Red" FontWeight="Bold" 
                                                             Command="{Binding DataContext.RemoveFolderPathCommand, RelativeSource={RelativeSource AncestorType={x:Type ListBoxItem}}}" 
                                                             CommandParameter="{Binding}" Padding="5,1" Margin="0,0,5,0" VerticalAlignment="Center" ToolTip="Delete this data folder"/>
                                                 </Grid>
                                             </DataTemplate>
                                         </ItemsControl.ItemTemplate>
                                     </ItemsControl>
                                     
                                     <StackPanel Grid.Row="3" Grid.Column="0" Orientation="Horizontal" Margin="0,5,0,0">
                                         <TextBlock Text="Merge In Dependency Records" VerticalAlignment="Center" 
                                                    ToolTip="{Binding MergeInToolTip}"
                                                    Foreground="{Binding MergeInLabelColor}"
                                                    Visibility="{Binding MergeInDependencyRecordsVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                         <CheckBox
                                             IsChecked="{Binding MergeInDependencyRecords}"
                                             Margin="5 0 0 0"
                                             ToolTip="{Binding MergeInDependencyRecords}"
                                             Visibility="{Binding MergeInDependencyRecordsVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                         
                                         <TextBlock Text="Search for Injected Records" VerticalAlignment="Center" 
                                                    Margin="10 0 0 0"
                                                    ToolTip="If checked, the patcher will search for and merge in records that are injected. This can potentially make patching take longer."
                                                    Visibility="{Binding MergeInDependencyRecordsVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                         <CheckBox
                                             IsChecked="{Binding HandleInjectedRecords}"
                                             Margin="5 0 0 0"
                                             ToolTip="If checked, the patcher will search for and merge in records that are injected. This can potentially make patching take longer."
                                             Visibility="{Binding MergeInDependencyRecordsVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                     </StackPanel>
                                     
                                     <StackPanel Grid.Row="4" Grid.Column="0" Orientation="Horizontal" Margin="0,5,0,0">
                                         <TextBlock Text="Record Override Handling Mode" VerticalAlignment="Center">
                                             <TextBlock.ToolTip>
                                                 <ToolTip>
                                                     <TextBlock TextWrapping="Wrap" Width="300">
                                                         Controls what happens if plugins in this mod override records from another mod 
                                                         (other than the direct NPC records).
                                                         <LineBreak/>
                                                         <LineBreak/>
                                                         Default: Use the default setting from the Settings Tab.
                                                         <LineBreak/>
                                                         Ignore: Do not look for overridden records. Conflict patching will be fully taken care of by you.
                                                         <LineBreak/>
                                                         Include: Incorporate the overridden records into the output (as whole records in Default mode,
                                                         or deltas in EasyNPC mode).
                                                         <LineBreak/>
                                                         Include as New: Copy the overrides as new records. Avoids conflicts if multiple appearance mods 
                                                         override the same records.
                                                     </TextBlock>
                                                 </ToolTip>
                                             </TextBlock.ToolTip>
                                         </TextBlock>

                                         <ComboBox
                                             ItemsSource="{Binding RecordOverrideHandlingModes}"
                                             DisplayMemberPath="Value"
                                             SelectedValuePath="Key"
                                             SelectedValue="{Binding OverrideRecordOverrideHandlingMode, Mode=TwoWay}"
                                             Margin="5 0 0 0"/>
                                     </StackPanel>
                                     
                                     <Button Grid.Row="5" Grid.Column="0"
                                             Content="Unlink Mugshot Data"
                                             Command="{Binding UnlinkMugshotDataCommand}"
                                             HorizontalAlignment="Left"
                                             Margin="0,10,0,0" Padding="5,2"
                                             ToolTip="Separates the assigned mugshot folder into its own entry, if its name differs from the primary mod data folder."
                                             Visibility="{Binding CanUnlinkMugshots, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                     
                                     <CheckBox Grid.Row="6" Grid.Column="0"
                                               Content="Include Outfits"
                                               IsChecked="{Binding IncludeOutfits, Mode=TwoWay}"
                                               VerticalAlignment="Center"
                                               Margin="0,5,0,0"
                                               HorizontalAlignment="Left"
                                               ToolTip="If checked, outfits from this mod will be transferred along with NPC appearance when in Create and Patch mode."
                                               Visibility="{Binding DataContext.CurrentPatchingMode, 
                                                 ElementName=ModSettingsItemsControl, 
                                                 Converter={StaticResource PatchingModeConverter}, 
                                                 ConverterParameter=CreateAndPatch}"/>

                                     
                                     <Button Grid.Row="7" Grid.Column="0"
                                             Content="Delete"
                                             Command="{Binding DeleteCommand}"
                                             HorizontalAlignment="Right"
                                             Margin="0,5,0,0" Padding="5,2"
                                             Foreground="Red" FontWeight="Bold"
                                             ToolTip="Permanently delete this empty entry. Only visible if no paths or mugshots are assigned."
                                             Visibility="{Binding CanDelete, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                 </Grid> 
                             </Border> 
                         </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                <!-- ============================ VIRTUALIZATION FIX END ============================ -->
            </Grid>

            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Center" VerticalAlignment="Stretch" Background="LightGray" x:Name="ColumnSplitter"/>

            <Grid Grid.Column="2">
                 <Grid.RowDefinitions>
                     <RowDefinition Height="Auto"/> 
                     <RowDefinition Height="*"/>    
                 </Grid.RowDefinitions>

                 <Border Grid.Row="0" BorderBrush="LightGray" BorderThickness="0,0,0,1" Padding="5" MinHeight="30">
                     <Grid>
                          <TextBlock Text="{Binding SelectedModForMugshots.DisplayName, StringFormat='Mugshots for: {0}', TargetNullValue='Select a mod from the left panel'}"
                                     FontSize="14" FontWeight="SemiBold" VerticalAlignment="Center" HorizontalAlignment="Left" TextTrimming="CharacterEllipsis"/>
                          <TextBlock Text="Loading Mugshots..." Foreground="Gray" FontStyle="Italic"
                                     VerticalAlignment="Center" HorizontalAlignment="Right"
                                     Visibility="{Binding IsLoadingMugshots, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                     </Grid>
                 </Border>

                 <ScrollViewer Grid.Row="1" x:Name="MugshotScrollViewer"
                               VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled"
                               HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                               SizeChanged="MugshotScrollViewer_SizeChanged"
                               PreviewMouseWheel="MugshotScrollViewer_PreviewMouseWheel">
                     <ItemsControl x:Name="MugshotsItemsControl" ItemsSource="{Binding CurrentModNpcMugshots}">
                         <ItemsControl.ItemsPanel>
                             <ItemsPanelTemplate>
                                 <WrapPanel Orientation="Horizontal"
                                            Width="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=ScrollViewer}}"/>
                             </ItemsPanelTemplate>
                         </ItemsControl.ItemsPanel>
                         <ItemsControl.ItemTemplate>
                             <DataTemplate DataType="{x:Type vm:VM_ModsMenuMugshot}">
                                 <Border BorderThickness="2" BorderBrush="{Binding BorderColor}" Margin="5" CornerRadius="2"
                                         Width="{Binding ImageWidth}" Height="{Binding ImageHeight}"
                                         PreviewMouseRightButtonDown="MugshotItem_PreviewMouseRightButtonDown"
                                         ToolTip="{Binding NpcDisplayName}">
                                     <!-- This Grid is the reference for the icon's percentage sizing -->
                                     <Grid Background="WhiteSmoke">
                                        <Image Source="{Binding MugshotSource}" Stretch="UniformToFill" UseLayoutRounding="True" SnapsToDevicePixels="True">
                                            <Image.Style>
                                                <Style TargetType="Image">
                                                    <Setter Property="Opacity" Value="1.0" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding HasMugshot}" Value="False">
                                                            <Setter Property="Opacity" Value="0.3"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Image.Style>
                                        </Image>
                                        <Border VerticalAlignment="Bottom" HorizontalAlignment="Stretch" Background="#AA000000" Padding="3,1">
                                            <TextBlock Text="{Binding NpcDisplayName}" Foreground="White" FontSize="10"
                                                        TextTrimming="CharacterEllipsis" HorizontalAlignment="Center"/>
                                        </Border>

                                        <!-- ============================ NEW ICON CODE START ============================ -->
                                        <!-- This Grid contains the icon, positioned in the bottom right corner. -->
                                        <!-- Its visibility is tied to the IsAmbiguousSource property. -->
                                        <Grid HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="0 0 0 10"
                                              Visibility="{Binding IsAmbiguousSource, Converter={StaticResource BooleanToVisibilityConverter}}"
                                              ToolTip="This NPC is defined in multiple source plugins. Right-click to select the correct source."
                                              Width="{Binding RelativeSource={RelativeSource AncestorType=Grid}, Path=ActualWidth, Converter={StaticResource PercentageSizingConverter}, ConverterParameter='20'}"
                                              Height="{Binding RelativeSource={RelativeSource Self}, Path=Width}">
                                            
                                            <!-- Viewbox ensures the icon image scales cleanly within the container Grid -->
                                            <Viewbox Stretch="Uniform">
                                                <Image Source="/NPC Plugin Chooser 2;component/Resources/Multiple Plugins for NPC.png" />
                                            </Viewbox>
                                        </Grid>
                                        <!-- ============================= NEW ICON CODE END ============================= -->
                                        
                                     </Grid>
                                     <Border.ContextMenu>
                                          <ContextMenu>
                                               <MenuItem Header="Jump to NPC in List" Command="{Binding JumpToNpcCommand}"/>
                                               <MenuItem Header="View Full Screen (Ctrl+RClick)" Command="{Binding ToggleFullScreenCommand}"/>
                                               <MenuItem Header="Select Source Plugin"
                                                         Visibility="{Binding IsAmbiguousSource, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                         ItemsSource="{Binding AvailableSourcePlugins}">
                                                   <MenuItem.ItemContainerStyle>
                                                       <Style TargetType="MenuItem">
                                                           <Setter Property="Header" Value="{Binding Converter={StaticResource ModKeyToStringConverter}}"/>
                                                           <Setter Property="Command" Value="{Binding DataContext.SetNpcSourcePluginCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                           <Setter Property="CommandParameter" Value="{Binding}"/>
                                                           <Setter Property="IsCheckable" Value="True"/>
                                                           <Setter Property="IsChecked">
                                                               <Setter.Value>
                                                                   <MultiBinding Converter="{StaticResource AreModKeysEqualMultiConverter}">
                                                                       <!-- AreModKeysEqualMultiConverter checks if the current menu item's ModKey (value[0])
                                                                            equals the VM_ModsMenuMugshot's CurrentSourcePlugin (value[1]) -->
                                                                       <Binding Path="."/> <!-- The ModKey for this MenuItem -->
                                                                       <Binding Path="DataContext.CurrentSourcePlugin" RelativeSource="{RelativeSource AncestorType=ContextMenu}"/>
                                                                   </MultiBinding>
                                                               </Setter.Value>
                                                           </Setter>
                                                       </Style>
                                                   </MenuItem.ItemContainerStyle>
                                               </MenuItem>
                                               <MenuItem Header="Select Same Source Plugin Where Possible"
                                                         Visibility="{Binding IsAmbiguousSource, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                         Command="{Binding SelectSameSourcePluginWherePossibleCommand}"
                                                         ToolTip="For all other ambiguous NPCs in this mod, sets their source to this source plugin if it contains the NPC."/>
                                          </ContextMenu>
                                     </Border.ContextMenu>
                                 </Border>
                             </DataTemplate>
                         </ItemsControl.ItemTemplate>
                     </ItemsControl>
                 </ScrollViewer>

                  <TextBlock Grid.Row="1" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="14" Foreground="Gray" TextWrapping="Wrap" Margin="20">
                      <TextBlock.Style>
                           <Style TargetType="TextBlock">
                              <Setter Property="Visibility" Value="Collapsed"/> 
                              <Style.Triggers>
                                  <DataTrigger Binding="{Binding SelectedModForMugshots}" Value="{x:Null}">
                                       <Setter Property="Visibility" Value="Visible"/>
                                       <Setter Property="Text" Value="Click a mod name link in the left panel to view its NPC mugshots."/>
                                  </DataTrigger>
                                  <MultiDataTrigger>
                                      <MultiDataTrigger.Conditions>
                                          <Condition Binding="{Binding SelectedModForMugshots, Converter={StaticResource IsNotNullConverter}}" Value="True"/>
                                          <Condition Binding="{Binding IsLoadingMugshots}" Value="False"/>
                                          <Condition Binding="{Binding CurrentModNpcMugshots.Count}" Value="0"/>
                                      </MultiDataTrigger.Conditions>
                                      <Setter Property="Visibility" Value="Visible"/>
                                      <Setter Property="Text" Value="No valid mugshot images found in the specified folder for the selected mod, or the folder path is invalid/inaccessible."/>
                                  </MultiDataTrigger>
                                  <DataTrigger Binding="{Binding IsLoadingMugshots}" Value="True">
                                      <Setter Property="Visibility" Value="Collapsed"/>
                                  </DataTrigger>
                              </Style.Triggers>
                          </Style>
                      </TextBlock.Style>
                  </TextBlock>
            </Grid>
        </Grid>


        <!-- NEW Zoom Control Row -->
        <Border Grid.Row="1" BorderBrush="Gray" BorderThickness="0,1,0,0" Padding="5">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"
                            Visibility="{Binding ShowSourcePluginControls, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <!-- Existing Source Plugin controls here... -->
                    <TextBlock Text="Source Plugin for Ambiguous NPCs:" VerticalAlignment="Center" Margin="10,0,5,0"
                           ToolTip="Select a plugin to be the default source for NPCs found in multiple plugins within this mod setting."/>
                    <ComboBox ItemsSource="{Binding AvailableSourcePluginsForSelectedMod}" 
                          SelectedItem="{Binding SelectedSourcePluginForDisambiguation, Mode=TwoWay}"
                          DisplayMemberPath="FileName"
                          MinWidth="150" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <Button Content="Set as Source Plugin" Command="{Binding SetGlobalSourcePluginCommand}" 
                        Padding="5,2" VerticalAlignment="Center"
                        ToolTip="Set the selected plugin as the primary source for all NPCs in this mod setting that are found in multiple plugins."/>
                </StackPanel>

                <!-- NEW: Batch Actions Panel -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="10,0,0,0">
                    <TextBlock Text="Batch Actions:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                    <Button Content="Include" Command="{Binding BatchIncludeOutfitsCommand}" Margin="5,0" Padding="5,2" ToolTip="Enable 'Include Outfits' for ALL mods."/>
                    <Button Content="Exclude" Command="{Binding BatchExcludeOutfitsCommand}" Padding="5,2" ToolTip="Disable 'Include Outfits' for ALL mods."/>
                    <TextBlock Text="Outfits" VerticalAlignment="Center" Margin="5,0,0,0"/>
                    
                    <Button Content="Enable" Command="{Binding BatchEnableInjectedRecordsCommand}" Margin="10,0" Padding="5,2" ToolTip="Enable 'Search for Injected Records' for ALL mods."/>
                    <Button Content="Disable" Command="{Binding BatchDisableInjectedRecordsCommand}" Padding="5,2" ToolTip="Disable 'Search for Injected Records' for ALL mods."/>
                    <TextBlock Text="Injected Record Search" VerticalAlignment="Center" Margin="5,0,0,0"/>
                </StackPanel>
                
                <!-- Existing Zoom controls -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <Button x:Name="ZoomOutButtonMods" Content="-" Width="25" Height="25" Margin="2,0" ToolTip="Zoom Out (Ctrl+Scroll Wheel)"/>
                    <TextBox x:Name="ZoomPercentageTextBoxMods" Width="60" Height="25" Margin="2,0" TextAlignment="Center" VerticalContentAlignment="Center"
                         Text="{Binding ModsViewZoomLevel, StringFormat='F2', Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         PreviewMouseWheel="ZoomPercentageTextBoxMods_PreviewMouseWheel"
                         ToolTip="Current Zoom Level. Editable. Ctrl+Scroll Wheel in image area or Scroll Wheel here to adjust."/>
                    <TextBlock Text="%" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <Button x:Name="ZoomInButtonMods" Content="+" Width="25" Height="25" Margin="2,0" ToolTip="Zoom In (Ctrl+Scroll Wheel)"/>
                    <CheckBox x:Name="LockZoomCheckBoxMods" Content="Lock Zoom" Margin="10,0,5,0" VerticalAlignment="Center" ToolTip="Lock the current zoom level. If unchecked, zoom adjusts to fit images."/>
                    <Button x:Name="ResetZoomModsButton" Content="Reset Zoom" Margin="5,0,0,0" Padding="5,2"
                        Command="{Binding ResetZoomModsCommand}"
                        ToolTip="Reset zoom to automatically fit images."/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</reactiveui:ReactiveUserControl>